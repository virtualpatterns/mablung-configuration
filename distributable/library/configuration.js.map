{"version":3,"sources":["../../source/library/configuration.js"],"names":["Clone","FileSystem","FileSystemPath","Is","JSON5","Merge","ObjectPath","URL","PATTERN_JSON","Configuration","constructor","root","_root","load","value","_load","merge","string","path","resolve","test","parse","readFileSync","module","pathToFileURL","default","functionOrAsyncFunction","returnValue","Promise","has","parameter","apply","get","set","reduce","accumulator","getOption","getParameter","_parameterObjectToArray","_mergeParameter","array","_parameterArrayToObject","Object","entries","filter","boolean","map","name","flat","redact","censor","_value","omit","del"],"mappings":"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","sourcesContent":["import Clone from 'clone'\nimport FileSystem from 'fs'\nimport FileSystemPath from 'path'\nimport { Is } from '@virtualpatterns/mablung-is'\nimport JSON5 from 'json5'\nimport Merge from 'deepmerge'\nimport ObjectPath from 'object-path'\nimport URL from 'url'\n\nconst PATTERN_JSON = /^.+\\.json5?$/i\n\nclass Configuration {\n\n  constructor(root = {}) {\n    this._root = root\n  }\n\n  get root() {\n    return this._root\n  }\n\n  async load(value) {\n    this._root = await this._load(value)\n  }\n\n  async merge(value) {\n    this._root = Configuration.merge(this._root, await this._load(value))\n  }\n\n  async _load(value) {\n\n    if (Is.string(value)) {\n\n      let path = FileSystemPath.resolve(value)\n\n      if (PATTERN_JSON.test(path)) {\n        return JSON5.parse(FileSystem.readFileSync(path, { 'encoding': 'utf-8' }))\n      }\n      else {\n\n        let module = null\n        module = await import(URL.pathToFileURL(path))\n        module = module.default ? module.default : module\n\n        if (Is.functionOrAsyncFunction(module)) {\n\n          let returnValue = null\n          returnValue = module(this)\n          returnValue = returnValue instanceof Promise ? await returnValue : returnValue\n\n          return returnValue\n\n        } else {\n          return module\n        }\n\n      }\n\n    } else {\n      return value\n    }\n\n  }\n\n  has(...parameter) {\n    return ObjectPath.has.apply(ObjectPath, [this._root, ...parameter])\n  }\n\n  get(...parameter) {\n    return ObjectPath.get.apply(ObjectPath, [this._root, ...parameter])\n  }\n\n  set(...parameter) {\n    return ObjectPath.set.apply(ObjectPath, [this._root, ...parameter])\n  }\n\n  static merge(...parameter) {\n    // Merge a set of objects\n    return parameter.reduce((accumulator, parameter) => Merge(accumulator, parameter), {})\n  }\n\n  static getOption(...parameter) {\n    return this.merge(...parameter)\n  }\n\n  static getParameter(...parameter) {\n    // Combine the below\n    return this._parameterObjectToArray(this._mergeParameter(...parameter))\n  }\n\n  static _mergeParameter(...parameter) {\n    // Merge a set of objects or arrays so that\n    // { 'a': true, 'b': false, 'c': 'abc' } and [ 'b', 'd', 'e', 'f' ] and ...\n    // becomes { 'a': true, 'b': true, 'c': 'abc', 'd': true, 'e': true, 'f': true }\n    return parameter.reduce((accumulator, parameter) => Merge(accumulator, Is.array(parameter) ? this._parameterArrayToObject(parameter) : parameter), {})\n  }\n\n  static _parameterArrayToObject(value) {\n    // Convert a parameter array of [ 'a', 'b', 'c' ] \n    // into an object { 'a': true, 'b': true, 'c': true }\n    return value.reduce((accumulator, value) => { \n      accumulator[value] = true \n      return accumulator\n    }, {})\n  }\n\n  static _parameterObjectToArray(value) {\n    // Convert a parameter object { 'a': true, 'b': false, 'c': 'abc', 'd': 1, 'e': 0 }\n    // into an array [ 'a', 'c', 'abc', 'd', 1, 'e', 0 ]\n\n\n    return Object.entries(value) // returns [ [ name, value ], [ name, value ], ... ]\n      .filter(([ , value ]) => Is.boolean(value) ? value : true) // if value is a boolean, filter out false values\n      .map(([ name, value ]) => Is.boolean(value) ? [ name ]: [ name, value ]) // if value is a boolean return only [ name ]\n      .flat()\n\n    // return Object.keys(value)\n    //   .filter((name) => Is.boolean(value[name]) ? value[name] : true) // remove any name/value pairs where value is false\n    //   .map((name) => {\n\n    //     Is.string(value[name]) {\n    //       return [ name, value[name] ]\n    //     }\n    //      : name\n    //   }) // separate name/value pairs into [ name, value ] or just name if it's not a string\n    //   .flat()\n\n  }\n\n  static redact(value, path, censor = '**********') {\n\n    let _value = null\n    _value = Clone(value)\n\n    ObjectPath.set(_value, path, censor)\n\n    return _value\n\n  }\n\n  static omit(value, path) {\n\n    let _value = null\n    _value = Clone(value)\n\n    ObjectPath.del(_value, path)\n\n    return _value\n\n  }\n\n}\n\nexport { Configuration }\n"],"file":"configuration.js"}